# Участие в разработке

## Требования для разработки

- Node.js 20+
- Расширение VS Code [1c-platform-tools](https://marketplace.visualstudio.com/items?itemName=yellow-hammer.1c-platform-tools) (для проверки работы с IPC)

## Проверка и отладка

### Что настроить (если MCP не подхватился сам)

В **VS Code** расширение регистрирует MCP автоматически — после установки и включения IPC в 1c-platform-tools ничего настраивать не нужно. Обычный пользователь (установка из Marketplace) не создаёт `mcp.json` — расширение задаёт команду и параметры запуска само.

При **разработке из исходников** в Cursor может понадобиться ручная настройка. Конфиг кладут в проект 1С, который открыт в Cursor: `<проект_1С>/.cursor/mcp.json`. Cursor запускает процесс с рабочей папкой = корень этого проекта, путь в `args` — **относительно корня проекта**.

Пример: репо `mcp-1c-platform-tools` лежит рядом с проектом (например `ssl_3_1` и `mcp-1c-platform-tools` в одной родительской папке). В проекте `ssl_3_1` создайте `.cursor/mcp.json`:

```json
{
  "mcpServers": {
    "mcp-1c-platform-tools": {
      "command": "npx",
      "args": ["-y", "tsx", "../mcp-1c-platform-tools/src/index.ts"],
      "env": {
        "ONEC_IPC_HOST": "127.0.0.1",
        "ONEC_IPC_PORT": "40241"
      }
    }
  }
}
```

Если репо в другом месте — укажите в `args` полный или относительный путь к `src/index.ts`. При своём порте/токене IPC задайте `ONEC_IPC_PORT` и `ONEC_IPC_TOKEN`. После сборки: `"command": "node", "args": ["out/index.js"]`, в `cwd` — корень репозитория `mcp-1c-platform-tools` (либо путь к `src/index.ts` относительно корня открытого проекта). После изменений перезапустите Cursor.

### Проверка работы

1. **Расширение**  
   В окне с проектом 1С включите IPC: настройки → `1c-platform-tools.ipc.enabled` = `true`. Перезагрузите окно.

2. **Проверка через агента**  
   Напишите агенту, например: *«Загрузи конфигурацию из исходников в ИБ для проекта C:\путь\к\моему-1с-проекту»* (подставьте путь к папке с `packagedef`). Должен вызваться MCP-инструмент и команда расширения.

### Отладка MCP-сервера

**Вариант A: запуск из IDE**  
В папке `mcp-1c-platform-tools` откройте Run and Debug (F5) и выберите конфигурацию **«MCP: запуск с отладкой»**. Процесс остановится на первой строке; поставьте нужные точки останова и нажмите «Продолжить». Сервер будет ждать ввода по stdin (протокол MCP). Для проверки с агентом в этом режиме неудобно, так как Cursor сам порождает свой процесс MCP — используйте вариант B.

**Вариант B: отладка процесса, запущенного Cursor**  
Чтобы отлаживать сервер, который запускает Cursor:

1. В конфиге MCP в Cursor временно замените команду на отладочную:  
   `"command": "npx", "args": ["-y", "tsx", "--inspect-brk=9229", "src/index.ts"]`, `cwd` — корень `mcp-1c-platform-tools` (env не нужен, порт 40241 по умолчанию).

2. Перезапустите Cursor (или перезагрузите окно), чтобы он заново поднял MCP-сервер. Процесс остановится на старте (из-за `--inspect-brk`).

3. В VS Code откройте репозиторий `mcp-1c-platform-tools`, Run and Debug → конфигурация **«MCP: подключиться к процессу (port 9229)»** → F5. После подключения нажмите «Продолжить» в панели отладки.

4. Вызовите агента в Cursor и выполните действие, которое дергает MCP — точки останова в коде MCP сработают.

### Отладка расширения 1c-platform-tools (IPC-сервер)

В репозитории `vscode-1c-platform-tools` используйте конфигурацию **«Run Extension»** (запуск Development Host с расширением). В открывшемся окне откройте проект 1С, включите IPC. Запустите MCP (отдельно или через Cursor) и вызовите инструмент — точки останова в `ipcServer.ts` сработают при обработке запросов.

## Установка и сборка

В корне репозитория:

```bash
npm install
npm run build
```

После сборки точка входа сервера: `out/index.js`.

Запуск собранного сервера:

```bash
node out/index.js
```

Сервер работает по протоколу MCP через `stdio` (stdin/stdout).

## Режим разработки

Запуск без предварительной сборки (через `tsx`):

```bash
npm run dev
```

В конфиге MCP при отладке можно указать `tsx src/index.ts` вместо `node out/index.js` (при этом `cwd` — корень репозитория).
